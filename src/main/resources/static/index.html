<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MindMate â€” Chat</title>

  <!-- Tailwind CDN (you're already using this) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* ---------- Custom styles (glassmorphism + animations) ---------- */
    :root{
      --glass-bg: rgba(255,255,255,0.65);
      --glass-border: rgba(255,255,255,0.36);
      --accent: #60a5fa;
      --accent-2: #7dd3fc;
    }

    body {
      background: linear-gradient(135deg, #e6f5ff 0%, #fef9e9 100%);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .glass {
      background: linear-gradient(135deg, rgba(255,255,255,0.60), rgba(255,255,255,0.45));
      backdrop-filter: blur(8px) saturate(1.05);
      border: 1px solid rgba(255,255,255,0.45);
      box-shadow: 0 10px 30px rgba(2,6,23,0.08);
    }

    /* Chat area */
    #chat-window {
      height: 58vh;
      min-height: 320px;
      max-height: 72vh;
      overflow-y: auto;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      scroll-behavior: smooth;
    }

    /* Message bubbles */
    .msg {
      max-width: 78%;
      padding: 10px 14px;
      border-radius: 14px;
      box-shadow: 0 4px 12px rgba(16,24,40,0.04);
      opacity: 0;
      transform: translateY(8px);
      animation: fadeUp .28s forwards ease;
    }

    .msg.user {
      align-self: flex-end;
      background: linear-gradient(180deg, rgba(125,211,252,0.12), rgba(99,102,241,0.06));
      border-top-right-radius: 4px;
      color: #0f172a;
    }

    .msg.bot {
      align-self: flex-start;
      background: linear-gradient(180deg, rgba(96,165,250,0.12), rgba(14,165,233,0.06));
      border-top-left-radius: 4px;
      color: #0f172a;
    }

    .meta {
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      font-size: 0.72rem;
      margin-top:6px;
      color: #475569;
      opacity: 0.85;
    }

    @keyframes fadeUp {
      to { opacity:1; transform: translateY(0); }
    }

    /* Typing indicator */
    .typing {
      display:flex;
      align-items:center;
      gap:6px;
    }
    .dot {
      width:8px;height:8px;border-radius:999px;background:var(--accent);
      animation: blink 1s infinite;
    }
    .dot:nth-child(2){ animation-delay: 0.12s; }
    .dot:nth-child(3){ animation-delay: 0.24s; }
    @keyframes blink {
      0%, 80%, 100% { opacity: 0.15; transform: translateY(0); }
      40% { opacity: 1; transform: translateY(-4px); }
    }

    /* Input bar */
    .input-area {
      transition: box-shadow .18s ease, transform .08s ease;
    }
    .input-area:focus-within {
      box-shadow: 0 8px 30px rgba(59,130,246,0.12);
      transform: translateY(-1px);
    }

    /* Responsive tweaks */
    @media (max-width: 640px) {
      #chat-window { height: 54vh; }
      .msg { max-width: 88%; padding: 10px; }
    }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center p-6">

  <div class="w-full max-w-3xl">
    <div class="glass rounded-2xl p-5 lg:p-7">
      <!-- Header -->
      <div class="flex items-center justify-between gap-4 mb-4">
        <div class="flex items-center gap-3">
          <div class="bg-white/60 rounded-full p-2 shadow-md">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-sky-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2m0 14v2m8.66-11.66l-1.42 1.42M4.76 18.24l-1.42-1.42M21 12h-2M5 12H3m15.36 4.95l-1.42-1.42M6.46 6.46 5.04 5.04" />
            </svg>
          </div>
          <div>
            <h1 class="text-lg lg:text-xl font-semibold text-sky-700">MindMate Assistant</h1>
            <p class="text-sm text-slate-500">A gentle space to reflect â€¢ <span id="user-email-display" class="font-medium text-slate-600"></span></p>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button id="new-chat-btn" title="Start a new conversation" class="px-3 py-2 rounded-md bg-white/60 hover:bg-white/70 text-slate-700 shadow-sm">New Conversation</button>

          <button id="logout-btn" title="Logout" class="px-3 py-2 rounded-md bg-red-50 text-red-600 hover:bg-red-100">Logout</button>
        </div>
      </div>

      <!-- Chat container -->
      <div class="grid grid-cols-1 lg:grid-cols-[1fr_320px] gap-6">
        <!-- left: chat area -->
        <div>
          <div id="chat-window" class="rounded-xl border border-white/60 overflow-hidden">
            <!-- messages appended here -->
          </div>

          <!-- input -->
          <div class="mt-4 input-area bg-white/65 border border-white/50 rounded-xl p-3 flex gap-3 items-start">
            <textarea id="user-input" rows="1"
              placeholder="Share what's on your mind... (Shift+Enter for newline)"
              class="flex-1 resize-none bg-transparent focus:outline-none text-slate-800 placeholder:text-slate-400"
            ></textarea>

            <div class="flex items-center gap-2">
              <button id="send-btn" class="inline-flex items-center gap-2 px-4 py-2 bg-sky-600 text-white rounded-lg shadow hover:scale-[1.02] disabled:opacity-50" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M22 2L11 13" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M22 2L15 22l-7-9-9-2 22-9z" />
                </svg>
                Send
              </button>
            </div>
          </div>

          <p class="mt-2 text-xs text-slate-500">Responses are generated by the assistant â€” feel free to ask anything gentle.</p>
        </div>

        <!-- right: info / motivation -->
        <aside class="hidden lg:block">
          <div class="glass rounded-lg p-4 h-full flex flex-col gap-4">
            <div>
              <h3 class="font-semibold text-sky-700">Daily Motivation</h3>
              <p class="text-sm text-slate-500 mt-1">Short uplifting quotes to brighten your day.</p>
              <div class="mt-3 flex gap-2">
                <button onclick="getQuote()" class="flex-1 px-3 py-2 rounded-md bg-emerald-400 text-white hover:brightness-95">Get Quote</button>
              </div>
              <p id="quote" class="mt-3 text-sm text-slate-600"></p>
            </div>

            <div>
              <h4 class="font-medium text-slate-700">Tips</h4>
              <ul class="text-sm text-slate-600 mt-2 space-y-2">
                <li>ðŸ§˜ Try breathing for 2 minutes when feeling overwhelmed.</li>
                <li>ðŸ“… Small routines help â€” one step at a time.</li>
                <li>ðŸ’¬ Be kind to yourself while you reflect.</li>
              </ul>
            </div>

            <div class="mt-auto text-xs text-slate-500">
              <strong>Privacy:</strong> Conversations are private on this device unless you share them.
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>

<script>
  const API_BASE_URL =
  window.location.hostname === "localhost"
    ? "http://localhost:8080"
    : "https://mindmate-27cv.onrender.com";

  // ---------- Config & elements ----------
  const email = localStorage.getItem("email");
  const chatWindow = document.getElementById("chat-window");
  const userInput = document.getElementById("user-input");
  const sendBtn = document.getElementById("send-btn");
  const logoutBtn = document.getElementById("logout-btn");
  const newChatBtn = document.getElementById("new-chat-btn");
  const emailDisplay = document.getElementById("user-email-display");

  // Redirect to login if not logged in
  if (!email) {
    window.location.href = "login.html";
  } else {
    emailDisplay.textContent = email;
  }

  // ---------- Utilities ----------
  function formatTime(dt) {
    const d = new Date(dt);
    return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  }

  function smoothScrollToBottom() {
    chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'smooth' });
  }

  function createMessageElement(text, who, timestamp = null) {
    const wrapper = document.createElement('div');
    wrapper.classList.add('msg', who === 'user' ? 'user' : 'bot');

    const content = document.createElement('div');
    content.className = 'content';
    content.innerText = text;
    wrapper.appendChild(content);

    if (timestamp) {
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `<span>${who === 'user' ? 'You' : 'MindMate'}</span><span>${formatTime(timestamp)}</span>`;
      wrapper.appendChild(meta);
    }

    return wrapper;
  }

  function showTypingIndicator() {
    const typing = document.createElement('div');
    typing.className = 'msg bot typing-indicator';
    typing.id = 'typing-indicator';
    typing.innerHTML = `<div class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;
    chatWindow.appendChild(typing);
    smoothScrollToBottom();
  }

  function removeTypingIndicator() {
    const t = document.getElementById('typing-indicator');
    if (t) t.remove();
  }

  // ---------- Chat flow ----------
  async function sendMessageToBackend(messageText) {
  const now = new Date().toISOString();
  const userEl = createMessageElement(messageText, 'user', now);
  chatWindow.appendChild(userEl);
  smoothScrollToBottom();

  showTypingIndicator();

  try {
    const resp = await fetch(`${API_BASE_URL}/api/chat/send`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email: email, message: messageText })
    });

    removeTypingIndicator();

    if (!resp.ok) {
      const botEl = createMessageElement(`Server error: ${resp.status}`, 'bot', new Date().toISOString());
      chatWindow.appendChild(botEl);
      smoothScrollToBottom();
      return;
    }

    const data = await resp.json();
    const botText = data.reply || "Sorry, I couldn't generate a response.";
    const botEl = createMessageElement(botText, 'bot', new Date().toISOString());
    chatWindow.appendChild(botEl);
    smoothScrollToBottom();

  } catch (err) {
    removeTypingIndicator();
    const botEl = createMessageElement("Unable to connect to server.", 'bot', new Date().toISOString());
    chatWindow.appendChild(botEl);
    smoothScrollToBottom();
  }
}

    

  // Send handler
  async function handleSend() {
    const text = userInput.value.trim();
    if (!text) return;

    // disable input while sending
    sendBtn.disabled = true;
    userInput.value = '';
    userInput.rows = 1;

    await sendMessageToBackend(text);

    // re-enable
    sendBtn.disabled = false;
    userInput.focus();
  }

  // Enter to send; Shift+Enter newline
  userInput.addEventListener('keydown', async (e) => {
    // resize textarea automatically
    userInput.style.height = 'auto';
    userInput.style.height = (userInput.scrollHeight) + 'px';

    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      if (!sendBtn.disabled) await handleSend();
    }
  });

  // Enable/disable send button depending on input
  userInput.addEventListener('input', () => {
    const val = userInput.value.trim();
    sendBtn.disabled = !val;
  });

  sendBtn.addEventListener('click', handleSend);

  // Logout
  logoutBtn.addEventListener('click', () => {
    localStorage.removeItem('email');
    window.location.href = 'login.html';
  });

  // New conversation (clears UI only)
  newChatBtn.addEventListener('click', () => {
    if (!confirm('Start a new conversation? (This clears only the chat view â€” your conversation remains in the database)')) return;
    chatWindow.innerHTML = '';
  });

  // ---------- Load history ----------
  async function loadChatHistory() {
  try {
    const res = await fetch(`${API_BASE_URL}/api/chat/history?email=${encodeURIComponent(email)}`);

    if (!res.ok) {
      console.warn('Could not load history:', res.status);
      return;
    }

    const msgs = await res.json();

    msgs.forEach(m => {
      const when = m.createdAt || new Date().toISOString();
      const who = (m.sender || '').toLowerCase() === 'user' ? 'user' : 'bot';
      chatWindow.appendChild(createMessageElement(m.message, who, when));
    });

    smoothScrollToBottom();
  } catch (err) {
    console.error('History load failed', err);
  }
}

      

  // ---------- Quote feature (keeps your fallback) ----------
  async function getQuote() {
    const quoteArea = document.getElementById('quote');
    const fallbackQuotes = [
      "You are enough, just as you are ðŸŒ¼",
      "One small positive thought can change your whole day â˜€ï¸",
      "Be gentle with yourself. Youâ€™re doing the best you can ðŸ’«",
      "Take it one step at a time. Youâ€™ve got this ðŸ’ª",
      "Peace comes from within. Breathe and let go ðŸƒ",
      "Your feelings are valid. Healing takes time ðŸ’–",
      "Even the darkest night will end and the sun will rise ðŸŒž",
      "Youâ€™ve survived 100% of your worst days ðŸŒ»"
    ];

    try {
      const res = await fetch("https://zenquotes.io/api/random");
      if (!res.ok) throw new Error('Network error');
      const arr = await res.json();
      quoteArea.textContent = `${arr[0].q} â€” ${arr[0].a}`;
    } catch (e) {
      quoteArea.textContent = fallbackQuotes[Math.floor(Math.random()*fallbackQuotes.length)] + " (offline)";
    }
  }

  // Initialize
  (function init() {
    // load history after a short fade-in
    setTimeout(loadChatHistory, 180);
    // small focus tweak
    setTimeout(() => userInput.focus(), 400);
  })();
</script>

</body>
</html>
